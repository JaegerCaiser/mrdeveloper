name: Sync Main back to Develop

on:
  workflow_run:
    workflows: ["Production Environment"]
    types:
      - completed

jobs:
  create-sync-pr:
    name: Create Sync Pull Request
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Configure Git User
        run: |
          git config --global user.name "mrdeveloper-bot"
          git config --global user.email "bot@mrdeveloper.dev"

      - name: Merge main into sync branch and push
        id: merge
        run: |
          echo "Starting sync process..."
          git fetch origin main develop
          if git merge-base --is-ancestor origin/main origin/develop; then
            echo "main is already merged into develop. No sync needed."
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "main has new commits. Proceeding with sync..."
          echo "sync_needed=true" >> $GITHUB_OUTPUT
          BRANCH_NAME="sync/main-to-develop"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -B $BRANCH_NAME origin/develop

          # Attempt to merge main into the sync branch.
          # The 'if' statement handles the exit code, so the step won't fail on merge conflicts.
          if git merge origin/main --allow-unrelated-histories --no-edit -m "chore: sync main back to develop"; then
            echo "Merge successful without conflicts."
          else
            echo "::warning::Merge failed, likely due to conflicts. Committing files with conflict markers for manual resolution."
            # After a failed merge, files with conflicts are in the working directory.
            # We add and commit them to be resolved in the PR.
            git add .
            git commit -m "chore: sync main with conflicts for manual resolution"
          fi

          git push --force https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git HEAD:$BRANCH_NAME

      - name: Create or Update Pull Request
        if: steps.merge.outputs.sync_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.merge.outputs.branch_name }}
        run: |
          EXISTING_PR_URL=$(gh pr list --base develop --head "$BRANCH_NAME" --state open --json url --jq '.[0].url')
          if [ -n "$EXISTING_PR_URL" ]; then
            echo "PR already exists: $EXISTING_PR_URL"
            gh pr comment "$EXISTING_PR_URL" --body "ðŸ”„ The sync branch has been updated with the latest changes from \`main\`."
          else
            echo "Creating new PR..."
            gh pr create \
              --base develop \
              --head "$BRANCH_NAME" \
              --title "ðŸ”„ [Auto-Sync] Merge main back into develop" \
              --body "This PR automatically syncs the latest production release from \`main\` back into \`develop\`."
          fi
