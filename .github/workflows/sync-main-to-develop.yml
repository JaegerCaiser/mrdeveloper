name: Sync Main back to Develop

on:
  workflow_run:
    workflows: ["Production Environment"]
    types:
      - completed

jobs:
  create-sync-pr:
    name: Create Sync Pull Request
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Configure Git User
        run: |
          git config --global user.name "mrdeveloper-bot"
          git config --global user.email "bot@mrdeveloper.dev"

      - name: Merge main into sync branch and push
        id: merge
        run: |
          echo "Starting sync process..."
          git fetch origin main develop
          if git merge-base --is-ancestor origin/main origin/develop; then
            echo "main is already merged into develop. No sync needed."
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "main has new commits. Proceeding with sync..."
          echo "sync_needed=true" >> $GITHUB_OUTPUT
          BRANCH_NAME="sync/main-to-develop"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -B $BRANCH_NAME origin/develop

          # Tenta fazer o merge da 'main' na branch de sincroniza칞칚o.
          # A estrutura 'if/else' trata o c칩digo de sa칤da, ent칚o o passo n칚o falhar치 em caso de conflitos.
          if git merge origin/main --allow-unrelated-histories --no-edit -m "chore: sync main back to develop"; then
            # Se o merge for bem-sucedido e n칚o houver conflitos.
            echo "Merge da main para a branch de sync foi bem-sucedido, sem conflitos."
          else
            # Se o merge falhar (geralmente por conflitos).
            echo "::warning::O merge falhou, provavelmente devido a conflitos. Arquivos com marcadores de conflito ser칚o commitados para resolu칞칚o manual."
            # Ap칩s uma falha de merge, os arquivos com conflitos est칚o no diret칩rio de trabalho.
            # Adicionamos e commitamos esses arquivos para que possam ser resolvidos no Pull Request.
            git add .
            git commit -m "chore: Sincroniza main com conflitos para resolu칞칚o manual"
          fi

          # Faz o push do resultado para o reposit칩rio, seja um merge limpo ou com conflitos.
          git push --force https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git HEAD:$BRANCH_NAME

      - name: Create or Update Pull Request
        if: steps.merge.outputs.sync_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.merge.outputs.branch_name }}
        run: |
          EXISTING_PR_URL=$(gh pr list --base develop --head "$BRANCH_NAME" --state open --json url --jq '.[0].url')
          if [ -n "$EXISTING_PR_URL" ]; then
            echo "PR already exists: $EXISTING_PR_URL"
            gh pr comment "$EXISTING_PR_URL" --body "游댃 The sync branch has been updated with the latest changes from \`main\`."
          else
            echo "Creating new PR..."
            gh pr create \
              --base develop \
              --head "$BRANCH_NAME" \
              --title "游댃 [Auto-Sync] Merge main back into develop" \
              --body "This PR automatically syncs the latest production release from \`main\` back into \`develop\`."
          fi
