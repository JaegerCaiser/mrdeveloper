name: Sync Main back to Develop

# Dispara este workflow QUANDO o workflow "Production Environment"
# (o 'name:' do seu production.yml) terminar com sucesso
on:
  workflow_run:
    workflows: ["Production Environment"]
    types:
      - completed

jobs:
  create-sync-pr:
    # S칩 roda se o workflow de produ칞칚o foi um sucesso
    if: github.event.workflow_run.conclusion == 'success'

    runs-on: ubuntu-latest
    permissions:
      # Essencial: permiss칚o para criar branchs e PRs
      contents: write
      pull-requests: write

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Configure Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "bot@users.noreply.github.com"

      - name: Merge main into a temp branch and push
        id: merge
        env:
          # O PAT 칠 necess치rio para o PUSH, para que o PR
          # que vamos criar dispare os status checks (o preview.yml)
          GH_PAT: ${{ secrets.GH_PAT_FOR_RELEASE }}
        run: |
          echo "Starting sync process..."

          # Verificar se o PAT est치 definido
          if [ -z "$GH_PAT" ]; then
            echo "Error: GH_PAT_FOR_RELEASE secret is not set"
            exit 1
          fi

          echo "GH_PAT is set, proceeding..."
          git fetch origin main develop
          echo "Fetched branches successfully"

          # Otimiza칞칚o: Verifica se 'main' j치 est치 no 'develop'
          echo "Checking if main is already merged into develop..."
          if git merge-base --is-ancestor origin/main origin/develop; then
            echo "main is already merged into develop. No sync needed."
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "main has new commits. Creating sync PR..."
          echo "sync_needed=true" >> $GITHUB_OUTPUT

          BRANCH_NAME="sync/main-to-develop-$GITHUB_RUN_ID"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Created branch name: $BRANCH_NAME"

          git checkout -b $BRANCH_NAME
          echo "Checked out new branch: $BRANCH_NAME"

          # Faz o merge do 'main' (com o commit do semantic-release)
          echo "Merging origin/main into $BRANCH_NAME..."
          git merge origin/main --no-edit -m "chore: sync main back to develop"
          echo "Merge completed successfully"

          # Push usando o PAT
          echo "Pushing branch to remote..."
          git push https://github-actions[bot]:${GH_PAT}@github.com/${{ github.repository }}.git HEAD:$BRANCH_NAME
          echo "Push completed successfully"

      - name: Create Pull Request
        if: steps.merge.outputs.sync_needed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          # O 'create-pull-request' usa o GITHUB_TOKEN padr칚o
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.merge.outputs.branch_name }}
          base: develop
          title: "游댃 [Auto-Sync] Merge main back into develop"
          body: |
            This PR automatically syncs the latest production release from `main` back into `develop`.

            Includes:
            - Version bump from `semantic-release`
            - Updated `CHANGELOG.md`
            - Any hotfixes that were merged to `main`
          delete-branch: true # Deleta o branch 'sync/...' ap칩s o merge
